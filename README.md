# Cloud Code (Cloudflare + OpenCode)

**Cloud Code** æ˜¯ä¸€ä¸ªç»“åˆäº† Cloudflare å¼ºå¤§åŸºç¡€è®¾æ–½ä¸ OpenCode æ™ºèƒ½èƒ½åŠ›çš„å®¹å™¨åŒ–ä»£ç†è§£å†³æ–¹æ¡ˆã€‚

è¿™æ˜¯ä¸€ä¸ªåŸºäº Cloudflare Workers å’Œ [Cloudflare Containers](https://developers.cloudflare.com/workers/runtime-apis/container/) çš„ TypeScript é¡¹ç›®ã€‚å®ƒåˆ©ç”¨ Cloudflare çš„åŸºç¡€è®¾æ–½æ¥è¿è¡Œå’Œç®¡ç†å®¹å™¨åŒ–å·¥ä½œè´Ÿè½½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚
- Node.js (æ¨è v20+)
- pnpm (æˆ– npm)
- Wrangler CLI (`npm install -g wrangler`)

### å®‰è£…ä¾èµ–

```bash
npm install
```

### æœ¬åœ°å¼€å‘

å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼š

```bash
npm run dev
# æˆ–è€…
npm run start
```

è¯¥å‘½ä»¤ä¼šå¯åŠ¨ `wrangler dev`ï¼Œæ¨¡æ‹Ÿ Cloudflare Workers ç¯å¢ƒã€‚

### ç”Ÿæˆç±»å‹å®šä¹‰

å¦‚æœä½ ä¿®æ”¹äº† `wrangler.jsonc` ä¸­çš„ bindingsï¼Œéœ€è¦é‡æ–°ç”Ÿæˆç±»å‹æ–‡ä»¶ï¼š

```bash
npm run cf-typegen
```

## ğŸ“¦ éƒ¨ç½²

éƒ¨ç½²ä»£ç åˆ° Cloudflare å…¨çƒç½‘ç»œï¼š

```bash
npm run deploy
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts        # Workers å…¥å£æ–‡ä»¶ (ExportedHandler)
â”‚   â”œâ”€â”€ container.ts    # AgentContainer ç±»å®šä¹‰ (ç»§æ‰¿è‡ª Container)
â”‚   â””â”€â”€ sse.ts          # SSE (Server-Sent Events) æµå¤„ç†é€»è¾‘
â”œâ”€â”€ worker-configuration.d.ts # è‡ªåŠ¨ç”Ÿæˆçš„ç¯å¢ƒç»‘å®šç±»å‹
â”œâ”€â”€ wrangler.jsonc      # Wrangler é…ç½®æ–‡ä»¶
â”œâ”€â”€ tsconfig.json       # TypeScript é…ç½®
â””â”€â”€ package.json
```

## ğŸ’¾ æ•°æ®æŒä¹…åŒ– (S3/R2)

Cloud Code å®¹å™¨å†…ç½®äº†å¯¹ S3 å…¼å®¹å­˜å‚¨ï¼ˆå¦‚ Cloudflare R2, AWS S3ï¼‰çš„æ”¯æŒï¼Œé€šè¿‡ `TigrisFS` å°†å¯¹è±¡å­˜å‚¨æŒ‚è½½ä¸ºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œå®ç°æ•°æ®çš„æŒä¹…åŒ–ä¿å­˜ã€‚

### ç¯å¢ƒå˜é‡é…ç½®

è¦å¯ç”¨æ•°æ®æŒä¹…åŒ–ï¼Œéœ€è¦åœ¨å®¹å™¨è¿è¡Œç¯å¢ƒä¸­é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

| å˜é‡å | æè¿° | æ˜¯å¦å¿…é¡» | é»˜è®¤å€¼ |
|--------|------|----------|--------|
| `S3_ENDPOINT` | S3 API ç«¯ç‚¹åœ°å€ | âœ… æ˜¯ | - |
| `S3_BUCKET` | å­˜å‚¨æ¡¶åç§° | âœ… æ˜¯ | - |
| `S3_ACCESS_KEY_ID` | è®¿é—®å¯†é’¥ ID | âœ… æ˜¯ | - |
| `S3_SECRET_ACCESS_KEY` | è®¿é—®å¯†é’¥ Secret | âœ… æ˜¯ | - |
| `S3_REGION` | å­˜å‚¨åŒºåŸŸ | âŒ å¦ | `auto` |
| `S3_PATH_STYLE` | æ˜¯å¦ä½¿ç”¨ Path Style è®¿é—® | âŒ å¦ | `false` |
| `S3_PREFIX` | å­˜å‚¨æ¡¶å†…çš„è·¯å¾„å‰ç¼€ï¼ˆå­ç›®å½•ï¼‰ | âŒ å¦ | (æ ¹ç›®å½•) |
| `TIGRISFS_ARGS` | ä¼ é€’ç»™ TigrisFS çš„é¢å¤–æŒ‚è½½å‚æ•° | âŒ å¦ | - |

### å·¥ä½œåŸç†

1. **æŒ‚è½½ç‚¹**: å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šå°† S3 å­˜å‚¨æ¡¶æŒ‚è½½åˆ° `/root/s3`ã€‚
2. **å·¥ä½œç›®å½•**: å®é™…çš„å·¥ä½œç©ºé—´ä½äº `/root/s3/workspace`ã€‚
3. **OpenCode é…ç½®**: OpenCode çš„é…ç½®æ–‡ä»¶ï¼ˆXDG ç›®å½•ï¼‰ä¹Ÿä¼šå­˜å‚¨åœ¨ `/root/s3/.opencode` ä¸­ï¼Œç¡®ä¿ç¼–è¾‘å™¨çŠ¶æ€æŒä¹…åŒ–ã€‚
4. **åˆå§‹åŒ–**:
   - å¦‚æœ S3 å­˜å‚¨æ¡¶ï¼ˆæˆ–æŒ‡å®šçš„å‰ç¼€è·¯å¾„ï¼‰ä¸ºç©ºï¼Œå®¹å™¨ä¼šè‡ªåŠ¨å°†é¢„ç½®çš„ `workspace` ç›®å½•å†…å®¹å¤åˆ¶è¿›å»ã€‚
   - å¦‚æœ S3 é…ç½®ç¼ºå¤±ï¼Œå®¹å™¨å°†å›é€€åˆ°éæŒä¹…åŒ–çš„æœ¬åœ°ç›®å½•æ¨¡å¼ã€‚

## ğŸŒ éš§é“ç©¿é€ (Cloudflared)

å®¹å™¨å†…é¢„è£…äº† `cloudflared` CLIï¼Œå¯ç”¨äºå°†å®¹å™¨å†…è¿è¡Œçš„æœåŠ¡ï¼ˆå¦‚å¼€å‘æœåŠ¡å™¨ã€Web åº”ç”¨ï¼‰é€šè¿‡ Cloudflare Tunnel æš´éœ²åˆ°å…¬ç½‘ã€‚

è¿™åœ¨ä»¥ä¸‹åœºæ™¯éå¸¸æœ‰ç”¨ï¼š
- è°ƒè¯•å®¹å™¨å†…è¿è¡Œçš„ Web æœåŠ¡
- ä¸´æ—¶å…±äº«å¼€å‘ç¯å¢ƒ
- é…ç½® SSH è®¿é—®

ä½¿ç”¨ç¤ºä¾‹ï¼ˆåœ¨å®¹å™¨ç»ˆç«¯ä¸­ï¼‰ï¼š

```bash
# å°†å®¹å™¨å†…çš„ 8080 ç«¯å£æš´éœ²åˆ°å…¬ç½‘
cloudflared tunnel --url http://localhost:8080
```

## ğŸ›  æŠ€æœ¯æ ˆ

- **Runtime**: Cloudflare Workers
- **è¯­è¨€**: TypeScript
- **æ ¸å¿ƒåº“**:
  - `cloudflare:workers`: Workers æ ‡å‡†åº“
  - `@cloudflare/containers`: å®¹å™¨ç®¡ç†ä¸äº¤äº’
- **å·¥å…·**: Wrangler
- **å®¹å™¨ç¯å¢ƒ**:
  - `nikolaik/python-nodejs`: Python 3.12 + Node.js 22
  - `tigrisfs`: S3 æ–‡ä»¶ç³»ç»ŸæŒ‚è½½
  - `cloudflared`: Cloudflare Tunnel å®¢æˆ·ç«¯
  - `opencode`: æ™ºèƒ½ç¼–ç ä»£ç†

## ğŸ“ å¼€å‘è§„èŒƒ

æœ¬é¡¹ç›®å®˜æ–¹è¯­è¨€ä¸º**ä¸­æ–‡**ã€‚
è¯¦ç»†çš„å¼€å‘è§„èŒƒã€ä»£ç é£æ ¼å’Œ Agent è¡Œä¸ºå‡†åˆ™ï¼Œè¯·å‚è€ƒ [AGENTS.md](./AGENTS.md)ã€‚
